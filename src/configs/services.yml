---
kind: Service
version: v1
services:
  - name: sshd
    command: /usr/sbin/sshd -D -f /etc/ssh/sshd_config -e
    autostart: ${SERVICE_ENABLE_SSHD}
    
  - name: k8gate
    command: /opt/sources/rabbitci/rabbit-ssh/bin/server.js
    autostart: ${SERVICE_ENABLE_API}
    
  - name: ssh-keys-sync
    command: /opt/sources/rabbitci/rabbit-ssh/bin/controller.keys.js
    autostart: ${SERVICE_ENABLE_SSHD}
    interval: 300
    autorestart: true
    user: root
    envs:
      - DEBUG=ssh:*,auth:*
      - HOME=/root
    # max_restarts: 50
    # restart_delay: 10000
    # log_date_format: YYYY-MM-DD HH:mm Z
    
  - name: k8gate
    command: node /opt/sources/rabbitci/rabbit-ssh/bin/server.js 2>&1 | tee -a /var/log/k8gate.log
    autostart: ${SERVICE_ENABLE_API}
    autorestart: true
    user: udx
    cwd: /opt/sources/rabbitci/rabbit-ssh
    envs:
      - DEBUG=k8gate:*,api:*,auth:*,ssh:*,sftp:*
      - NODE_ENV=production
      - PORT=8080
      - NODE_PORT=8080
      - HOME=/home/udx
      - SERVICE_ENABLE_API=true
      - SERVICE_ENABLE_SSHD=true
    healthcheck:
      http:
        port: ${NODE_PORT}
        path: /health
        interval: 10s
        timeout: 3s
        retries: 2
    
  # Firebase events service removed

  - name: ssh-keys-sync
    command: node /opt/sources/rabbitci/rabbit-ssh/bin/controller.keys.js 2>&1 | tee -a /var/log/ssh-keys-sync.log
    autostart: ${SERVICE_ENABLE_SSHD}
    autorestart: true
    user: udx
    cwd: /opt/sources/rabbitci/rabbit-ssh
    envs:
      - DEBUG=ssh:keys:*,auth:*
      - DIRECTORY_KEYS_BASE=/etc/ssh/authorized_keys.d
      - PASSWORD_FILE=/etc/passwd
      - PASSWORDS_TEMPLATE=alpine.passwords
      - HOME=/home/udx
    depends_on:
      - sshd
    interval: 300  # Run every 5 minutes
    max_restarts: 0  # No limit on restarts
    restart_delay: 10000  # Wait 10s between restarts
